<script>
/* ================== Config ================== */
const TOKEN = "0x7DB860CC9D7f64Ed1B39de6621ebc94440C8dc62";
const CHEF  = "0xEa13c02F1c69668c2C9f873Fe6fdf44FDD3B0C3C";
const FAUCET = "0x0000000000000000000000000000000000000000"; // à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰

/* ================== ABIs ================== */
const ABIchef = [
  "function deposit(uint256) external",
  "function withdraw(uint256) external",
  "function pendingReward(address) view returns(uint256)",
  "function stakes(address) view returns(uint256 amount,uint256 rewardDebt)"
];
const ABItoken = [
  "function balanceOf(address) view returns(uint256)",
  "function decimals() view returns(uint8)",
  "function allowance(address,address) view returns(uint256)",
  "function approve(address,uint256) returns(bool)"
];
/* ================== Helpers ================== */
const $=(id)=>document.getElementById(id);
const play=(id)=>{const a=$(id);if(a){try{a.currentTime=0;a.play()}catch{}}};
function fmt(bn,dec=18){try{return parseFloat(ethers.utils.formatUnits(bn,dec)).toFixed(2)}catch{return "0.00"}}

/* ================== State ================== */
let provider, signer, user, token, chef, dec=18;

/* ================== Language ================== */
let lang = localStorage.getItem("DNX_LANG") || "TH";
const text = {
  TH:{toggle:"EN", connect:"ðŸ”— à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸à¸£à¸°à¹€à¸›à¹‹à¸²", free:"ðŸŽ Claim 500 DNX à¸Ÿà¸£à¸µ", wallet:"à¸à¸£à¸°à¹€à¸›à¹‹à¸²", total:"à¸¢à¸­à¸” DNX à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", stake:"à¸ˆà¸³à¸™à¸§à¸™ Stake", reward:"à¸£à¸²à¸‡à¸§à¸±à¸¥à¸„à¹‰à¸²à¸‡à¸£à¸±à¸š", placeholder:"à¸à¸£à¸­à¸à¸ˆà¸³à¸™à¸§à¸™ DNX", deposit:"ðŸ’° à¸à¸²à¸ (Deposit)", withdraw:"ðŸ’Ž à¸–à¸­à¸™ (Withdraw)", claim:"ðŸŽ à¸£à¸±à¸šà¸£à¸²à¸‡à¸§à¸±à¸¥ (Claim)", buy:"ðŸ›’ BUY DNX", refresh:"ðŸ”„ Refresh", already:"à¸„à¸¸à¸“à¸£à¸±à¸šà¹„à¸›à¹à¸¥à¹‰à¸§", needConnect:"à¸à¸£à¸¸à¸“à¸²à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸à¸£à¸°à¹€à¸›à¹‹à¸²à¸à¹ˆà¸­à¸™"},
  EN:{toggle:"TH", connect:"ðŸ”— Connect Wallet", free:"ðŸŽ Claim 500 DNX Free", wallet:"Wallet", total:"Total DNX", stake:"Your Stake", reward:"Pending Rewards", placeholder:"Enter DNX amount", deposit:"ðŸ’° Deposit", withdraw:"ðŸ’Ž Withdraw", claim:"ðŸŽ Claim Rewards", buy:"ðŸ›’ BUY DNX", refresh:"ðŸ”„ Refresh", already:"Already claimed", needConnect:"Please connect wallet first"}
};
function applyLang(){
  const L=text[lang];
  $("langToggle").textContent=L.toggle;
  $("connectBtn").textContent=L.connect;
  $("claimFreeTop").textContent=L.free;
  $("lblWallet").textContent=L.wallet;
  $("lblBal").textContent=L.total;
  $("lblStake").textContent=L.stake;
  $("lblReward").textContent=L.reward;
  $("amount").placeholder=L.placeholder;
  $("deposit").textContent=L.deposit;
  $("withdraw").textContent=L.withdraw;
  $("claim").textContent=L.claim;
  $("buyDNX").textContent=L.buy;
  $("refreshSmall").textContent=L.refresh;
}
$("langToggle").addEventListener("click",()=>{
  play("clickSound");
  lang = (lang==="TH")?"EN":"TH";
  localStorage.setItem("DNX_LANG",lang);
  applyLang();
});
applyLang();

/* ================== Connect Wallet ================== */
async function connect(){
  play("clickSound");
  if(typeof window.ethereum === "undefined"){
    alert("âš ï¸ MetaMask not found");
    return;
  }
  try{
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    user = accounts[0];
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    token = new ethers.Contract(TOKEN, ABItoken, signer);
    chef  = new ethers.Contract(CHEF , ABIchef , signer);
    try{ dec = await token.decimals(); }catch{ dec=18; }
    $("waddr").textContent = user.slice(0,6)+"..."+user.slice(-4);
    play("rewardSound");
    console.log("âœ… Connected wallet:", user);
    refreshData();
  }catch(err){
    console.error(err);
    alert("âŒ " + (err?.message || "Connection failed"));
  }
}
$("connectBtn").addEventListener("click",connect);

/* ================== Refresh Data ================== */
async function refreshData(){
  if(!user){ alert(text[lang].needConnect); return; }
  try{
    const rt = new ethers.Contract(TOKEN,ABItoken,provider);
    const rc = new ethers.Contract(CHEF ,ABIchef ,provider);
    const [bal, stakeInfo, pending] = await Promise.all([
      rt.balanceOf(user),
      rc.stakes(user),
      rc.pendingReward(user)
    ]);
    $("bal").textContent = fmt(bal,dec);
    $("staked").textContent = fmt(stakeInfo.amount || 0,dec);
    $("pending").textContent = fmt(pending,dec);
    console.log("ðŸ“Š Balance:", fmt(bal,dec), "| Stake:", fmt(stakeInfo.amount,dec), "| Pending:", fmt(pending,dec));
  }catch(e){ console.error("âš ï¸ refreshData error:", e); }
}
$("refreshSmall").addEventListener("click",()=>{ play("clickSound"); refreshData(); });

/* ================== Approve Helper ================== */
async function ensureApprove(amount){
  const allow = await token.allowance(user,CHEF);
  if(allow.gte(amount)) return;
  console.log("ðŸ”‘ Approving token...");
  const tx = await token.approve(CHEF, ethers.constants.MaxUint256);
  await tx.wait();
  console.log("âœ… Approved successfully");
}

/* ================== Deposit / Withdraw / Claim ================== */
async function onDeposit(){
  try{
    play("clickSound");
    if(!signer) return alert(text[lang].needConnect);
    const v=$("amount").value.trim();
    if(!v) return;
    const amt = ethers.utils.parseUnits(v,dec);
    console.log("ðŸš€ Deposit:", v, "â†’", amt.toString());
    await ensureApprove(amt);
    const tx = await chef.deposit(amt);
    console.log("â›½ Tx sent:", tx.hash);
    await tx.wait();
    play("rewardSound");
    console.log("âœ… Deposit success!");
    $("amount").value="";
    refreshData();
  }catch(err){
    console.error("âŒ Deposit error:", err);
    alert("Deposit Error: " + (err?.message || "Unknown error"));
  }
}

async function onWithdraw(){
  try{
    play("clickSound");
    if(!signer) return alert(text[lang].needConnect);
    const v=$("amount").value.trim();
    if(!v) return;
    const amt = ethers.utils.parseUnits(v,dec);
    console.log("ðŸš€ Withdraw:", v, "â†’", amt.toString());
    const tx = await chef.withdraw(amt);
    console.log("â›½ Tx sent:", tx.hash);
    await tx.wait();
    play("rewardSound");
    console.log("âœ… Withdraw success!");
    $("amount").value="";
    refreshData();
  }catch(err){
    console.error("âŒ Withdraw error:", err);
    alert("Withdraw Error: " + (err?.message || "Unknown error"));
  }
}

async function onClaim(){
  try{
    if(!signer) return alert(text[lang].needConnect);
    console.log("ðŸŽ Claim Rewards...");
    const tx=await chef.deposit(0);
    console.log("â›½ Tx sent:", tx.hash);
    await tx.wait();
    $("claim").classList.add("glowClaim");
    play("rewardSound");
    setTimeout(()=>$("claim").classList.remove("glowClaim"),900);
    console.log("âœ… Claim success!");
    refreshData();
  }catch(err){
    console.error("âŒ Claim error:", err);
    alert("Claim Error: " + (err?.message || "Unknown error"));
  }
}

/* ================== Buy DNX ================== */
function buyDNX(){
  play("clickSound");
  window.open("https://pancakeswap.finance/swap?outputCurrency="+TOKEN,"_blank");
}

/* ================== Bind Buttons ================== */
$("deposit").addEventListener("click", onDeposit);
$("withdraw").addEventListener("click", onWithdraw);
$("claim").addEventListener("click", onClaim);
$("buyDNX").addEventListener("click", buyDNX);
["langToggle","refreshSmall"].forEach(id=>{
  const el=$(id); if(el) el.addEventListener("click",()=>play("clickSound"));
});
</script>
