<script>
const TOKEN="0x7DB860CC9D7f64Ed1B39de6621ebc94440C8dc62"; // DNXToken
const STAKING_V2="0x32A2828c6A5F095d4e8F0687Cdcc39294923e7d5"; // DNXStakingMC ‡πÉ‡∏´‡∏°‡πà
const TREASURY="0x3F221Dd0A1ecBa6E3Ed3CA78aC7EeD0E99b12F70";   // DNXTreasury ‡πÉ‡∏´‡∏°‡πà

const ABI_V2=[
 "function deposit(uint256) external",
 "function withdraw(uint256) external",
 "function claim() external",
 "function userInfo(address) view returns(uint256 amount,uint256 rewardDebt)",
 "function pendingReward(address) view returns(uint256)",
 "function rewardRatePerSec() view returns(uint256)",
 "function setRewardRatePerSec(uint256) external",
 "function owner() view returns(address)"
];
const ABI_TOKEN=[
 "function balanceOf(address) view returns(uint256)",
 "function decimals() view returns(uint8)",
 "function allowance(address,address) view returns(uint256)",
 "function approve(address,uint256) returns(bool)"
];

let provider,signer,user,token,v2,decimals;
const $=id=>document.getElementById(id);

// ‡∏õ‡∏∏‡πà‡∏° Refresh
$("refreshSmall").onclick=()=>{
 const b=$("refreshSmall");
 b.classList.add("loading");
 refresh();
 setTimeout(()=>b.classList.remove("loading"),1200);
};

// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MetaMask
async function connect(){
 if(!window.ethereum){alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask");return;}
 const acc=await ethereum.request({method:"eth_requestAccounts"});
 user=acc[0];
 provider=new ethers.providers.Web3Provider(window.ethereum);
 signer=provider.getSigner();
 token=new ethers.Contract(TOKEN,ABI_TOKEN,signer);
 v2=new ethers.Contract(STAKING_V2,ABI_V2,signer);
 decimals=await token.decimals();
 $("addr").textContent=user.slice(0,6)+"..."+user.slice(-4);
 refresh();
 showAdminPanel();
}
$("connectBtn").onclick=connect;

// ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function refresh(){
 if(!user)return;
 const [bal,info,pending]=await Promise.all([
   token.balanceOf(user),
   v2.userInfo(user),
   v2.pendingReward(user)
 ]);
 $("bal").textContent=(+ethers.utils.formatUnits(bal,decimals)).toFixed(4);
 $("st2").textContent=(+ethers.utils.formatUnits(info.amount,decimals)).toFixed(4);
 $("rw2").textContent=(+ethers.utils.formatUnits(pending,decimals)).toFixed(6);
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö approve DNX ‡∏Å‡πà‡∏≠‡∏ô‡∏ù‡∏≤‡∏Å
async function ensureApprove(amt){
 const allow=await token.allowance(user,STAKING_V2);
 if(allow.gte(amt))return;
 const tx=await token.approve(STAKING_V2,ethers.constants.MaxUint256);
 await tx.wait();
}

// ‡∏ù‡∏≤‡∏Å (Deposit)
$("dep").onclick=async()=>{
 const val=$("amt").value.trim();
 if(!val)return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô");
 const amt=ethers.utils.parseUnits(val,decimals);
 await ensureApprove(amt);
 const tx=await v2.deposit(amt);await tx.wait();
 alert("‚úÖ ‡∏ù‡∏≤‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");$("amt").value="";refresh();
};

// ‡∏ñ‡∏≠‡∏ô (Withdraw)
$("wd").onclick=async()=>{
 const val=$("amt").value.trim();
 if(!val)return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô");
 const amt=ethers.utils.parseUnits(val,decimals);
 const tx=await v2.withdraw(amt);await tx.wait();
 alert("‚úÖ ‡∏ñ‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");$("amt").value="";refresh();
};

// ‡πÄ‡∏Ñ‡∏•‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
$("claim").onclick=async()=>{
 const tx=await v2.claim();await tx.wait();
 alert("‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");refresh();
};

// üåê ‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏©‡∏≤
let lang=localStorage.getItem("DNX_LANG")||"TH";
const text={
 TH:{toggle:"EN",wallet:"‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤",total:"‡∏¢‡∏≠‡∏î DNX ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",stake:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Stake",reward:"‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö"},
 EN:{toggle:"TH",wallet:"Wallet",total:"Total DNX",stake:"Your Stake",reward:"Pending Reward"}
};
function applyLang(){
 const L=text[lang];
 $("langToggle").textContent=L.toggle;
 $("lblWallet").textContent=L.wallet;
 $("lblBal").textContent=L.total;
 $("lblStake").textContent=L.stake;
 $("lblReward").textContent=L.reward;
}
$("langToggle").onclick=()=>{lang=(lang==="TH")?"EN":"TH";localStorage.setItem("DNX_LANG",lang);applyLang();};
applyLang();

// ‚öôÔ∏è ‡πÅ‡∏ú‡∏á Admin (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
async function showAdminPanel(){
 try{
   const owner=await v2.owner();
   if(owner.toLowerCase()!==user.toLowerCase())return;
   const box=document.createElement("div");
   box.style.marginTop="16px";
   box.style.background="rgba(0,0,0,.6)";
   box.style.border="1px solid var(--gold)";
   box.style.borderRadius="10px";
   box.style.padding="14px";
   box.innerHTML=`
     <h3 style="color:var(--gold);margin-bottom:6px;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (Admin)</h3>
     <input id="monthPercent" type="number" step="0.01" min="0" value="30" style="width:120px;padding:6px;border-radius:6px;border:1px solid var(--neon);background:#000;color:#0ff;text-align:center"> %
     <button id="calcRate" class="action btn" style="padding:6px 12px;margin-left:8px;">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
     <div id="rateResult" style="margin-top:8px;color:#00ffd5;font-size:13px;"></div>
     <button id="updateRate" class="action gold" style="display:none;margin-top:8px;">üöÄ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡∏°‡πà</button>`;
   document.querySelector("#poolV2").appendChild(box);

   const monthInput=box.querySelector("#monthPercent");
   const res=box.querySelector("#rateResult");
   const btnCalc=box.querySelector("#calcRate");
   const btnUpdate=box.querySelector("#updateRate");
   let newRateWei=null;

   btnCalc.onclick=()=>{
     const p=parseFloat(monthInput.value);
     if(isNaN(p)||p<=0){res.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç > 0";return;}
     const secondsInMonth=30*24*60*60;
     const rate=p/100/secondsInMonth;
     newRateWei=ethers.utils.parseUnits(rate.toFixed(18),18);
     res.innerHTML=`‚û°Ô∏è rewardRatePerSec = <b>${newRateWei.toString()}</b><br>(‚âà ${rate.toFixed(18)} DNX/s)`;
     btnUpdate.style.display="inline-block";
   };
   btnUpdate.onclick=async()=>{
     if(!newRateWei){alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì");return;}
     const tx=await v2.setRewardRatePerSec(newRateWei);
     await tx.wait();
     alert("‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");res.innerHTML+="<br>‚úÖ Done";btnUpdate.style.display="none";
   };
 }catch(e){console.log("‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Owner ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",e);}
}
</script>
