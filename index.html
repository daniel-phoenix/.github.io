<script>
window.addEventListener("load", async () => {
  const TOKEN = "0x7DB860CC9D7f64Ed1B39de6621ebc94440C8dc62";
  const STAKING = "0x4CBc7013c8CF3347bba5775806C9Ec539Fe42E00";

  const ABItoken = [
    "function balanceOf(address) view returns(uint256)",
    "function decimals() view returns(uint8)",
    "function allowance(address,address) view returns(uint256)",
    "function approve(address,uint256) returns(bool)"
  ];

  const ABIstaking = [
    "function stake(uint256) external",
    "function unstake(uint256) external",
    "function pendingReward(address) view returns(uint256)",
    "function userInfo(address) view returns(uint256 amount,uint256 rewardDebt)",
    "function totalStaked() view returns(uint256)",
    "function rewardRate() view returns(uint256)"
  ];

  const $ = id => document.getElementById(id);
  const fmt = (bn, dec = 18) => {
    try { return parseFloat(ethers.utils.formatUnits(bn, dec)).toFixed(4); }
    catch { return "0.0000"; }
  };

  let provider, signer, user, token, staking, dec = 18;

  async function connect() {
    if (!window.ethereum) return alert("❌ กรุณาเปิด MetaMask");
    try {
      const acc = await ethereum.request({ method: "eth_requestAccounts" });
      user = acc[0];
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      token = new ethers.Contract(TOKEN, ABItoken, signer);
      staking = new ethers.Contract(STAKING, ABIstaking, signer);
      dec = await token.decimals();
      $("waddr").textContent = user.slice(0, 6) + "..." + user.slice(-4);
      refreshData();
      setInterval(refreshData, 5000); // อัปเดตทุก 5 วินาที
    } catch (e) {
      console.error(e);
      alert("เชื่อมต่อไม่สำเร็จ");
    }
  }

  $("connectBtn").onclick = connect;

  async function refreshData() {
    if (!user) return;
    try {
      const [bal, info, pending] = await Promise.all([
        token.balanceOf(user),
        staking.userInfo(user),
        staking.pendingReward(user)
      ]);
      $("bal").textContent = fmt(bal, dec);
      $("staked").textContent = fmt(info.amount, dec);
      $("pending").textContent = fmt(pending, dec);
    } catch (e) { console.error(e); }
  }

  async function ensureApprove(amount) {
    const allow = await token.allowance(user, STAKING);
    if (allow.gte(amount)) return;
    const tx = await token.approve(STAKING, ethers.constants.MaxUint256);
    await tx.wait();
  }

  $("deposit").onclick = async () => {
    const v = $("amount").value.trim();
    if (!v) return;
    const amt = ethers.utils.parseUnits(v, dec);
    await ensureApprove(amt);
    const tx = await staking.stake(amt);
    await tx.wait();
    alert("✅ ฝากสำเร็จ!");
    $("amount").value = "";
    refreshData();
  };

  $("withdraw").onclick = async () => {
    const v = $("amount").value.trim();
    if (!v) return;
    const amt = ethers.utils.parseUnits(v, dec);
    const tx = await staking.unstake(amt);
    await tx.wait();
    alert("✅ ถอนสำเร็จ!");
    $("amount").value = "";
    refreshData();
  };

  $("claim").onclick = async () => {
    const tx = await staking.stake(0);
    await tx.wait();
    alert("✅ เคลมรางวัลสำเร็จ!");
    refreshData();
  };

  $("buyDNX").onclick = () => {
    window.location.href = `https://pancakeswap.finance/swap?outputCurrency=${TOKEN}`;
  };
});
</script>
