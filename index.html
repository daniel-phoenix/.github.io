<script>
/* ================== CONFIG ================== */
const TOKEN = "0x7DB860CC9D7f64Ed1B39de6621ebc94440C8dc62"; // DNX Token
const CHEF  = "0xEa13c02F1c69668c2C9f873Fe6fdf44FDD3B0C3C"; // DNX Staking
const PANCAKE_API = "https://api.pancakeswap.info/api/v2/tokens/" + TOKEN;

/* ================== ABIs ================== */
const ABIchef = [
  "function deposit(uint256) external",
  "function withdraw(uint256) external",
  "function pendingReward(address) view returns(uint256)",
  "function stakes(address) view returns(uint256 amount,uint256 rewardDebt)"
];
const ABItoken = [
  "function balanceOf(address) view returns(uint256)",
  "function decimals() view returns(uint8)",
  "function allowance(address,address) view returns(uint256)",
  "function approve(address,uint256) returns(bool)"
];

/* ================== SHORTCUT ================== */
const $=(id)=>document.getElementById(id);
const play=(id)=>{const a=$(id);if(a){try{a.currentTime=0;a.play()}catch{}}};
const fmt=(bn,dec=18)=>{try{return parseFloat(ethers.utils.formatUnits(bn,dec)).toFixed(2)}catch{return "0.00"}};

/* ================== GLOBAL ================== */
let provider, signer, user, token, chef, dec=18, priceUSD=0;

/* ================== ALERT ================== */
function showMsg(msg,color="gold"){
  let box=$("msgBox");
  if(!box){
    box=document.createElement("div");
    box.id="msgBox";
    box.style.position="fixed";
    box.style.bottom="15px";
    box.style.left="50%";
    box.style.transform="translateX(-50%)";
    box.style.padding="10px 18px";
    box.style.background="#111";
    box.style.color=color;
    box.style.border="1px solid "+color;
    box.style.borderRadius="10px";
    box.style.fontFamily="Poppins, sans-serif";
    box.style.zIndex="9999";
    document.body.appendChild(box);
  }
  box.textContent=msg;
  setTimeout(()=>box.remove(),3000);
}

/* ================== LANGUAGE ================== */
let lang = localStorage.getItem("DNX_LANG") || "TH";
const text = {
  TH:{toggle:"EN", connect:"üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", wallet:"‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", total:"‡∏¢‡∏≠‡∏î DNX ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", stake:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Stake", reward:"‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö", needConnect:"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô"},
  EN:{toggle:"TH", connect:"üîó Connect Wallet", wallet:"Wallet", total:"Total DNX", stake:"Your Stake", reward:"Pending Rewards", needConnect:"Please connect wallet first"}
};
function applyLang(){
  const L=text[lang];
  $("langToggle").textContent=L.toggle;
  $("connectBtn").textContent=L.connect;
  $("lblWallet").textContent=L.wallet;
  $("lblBal").textContent=L.total;
  $("lblStake").textContent=L.stake;
  $("lblReward").textContent=L.reward;
}
$("langToggle").onclick=()=>{play("clickSound");lang=(lang==="TH")?"EN":"TH";localStorage.setItem("DNX_LANG",lang);applyLang();}
applyLang();

/* ================== CONNECT WALLET ================== */
async function connect(){
  play("clickSound");
  if(!window.ethereum) return showMsg("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ MetaMask","red");
  try{
    const accounts = await window.ethereum.request({method:"eth_requestAccounts"});
    user=accounts[0];
    provider=new ethers.providers.Web3Provider(window.ethereum);
    signer=provider.getSigner();
    token=new ethers.Contract(TOKEN,ABItoken,signer);
    chef=new ethers.Contract(CHEF,ABIchef,signer);
    dec=await token.decimals();
    $("waddr").textContent=user.slice(0,6)+"..."+user.slice(-4);
    showMsg("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß");
    play("rewardSound");
    refreshData();
  }catch(e){console.error(e);showMsg("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","red");}
}
$("connectBtn").onclick=connect;

/* ================== REFRESH DATA ================== */
async function refreshData(){
  if(!user) return showMsg(text[lang].needConnect,"red");
  try{
    const [bal, info, pending] = await Promise.all([
      token.balanceOf(user),
      chef.stakes(user),
      chef.pendingReward(user)
    ]);
    $("bal").textContent = fmt(bal,dec);
    $("staked").textContent = fmt(info.amount,dec);
    $("pending").textContent = fmt(pending,dec);

    // üíµ ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô USD
    if(priceUSD>0){
      const usd = (parseFloat(fmt(pending,dec)) * priceUSD).toFixed(4);
      $("pendingUSD").textContent = `‚âà $${usd}`;
    }
  }catch(e){console.error(e);showMsg("‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ","red");}
}
$("refreshSmall").onclick=()=>{play("clickSound");refreshData();};

/* ================== APPROVE ================== */
async function ensureApprove(amount){
  const allow=await token.allowance(user,CHEF);
  if(allow.gte(amount))return;
  showMsg("üîë ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...");
  const tx=await token.approve(CHEF,ethers.constants.MaxUint256);
  await tx.wait();
  showMsg("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}

/* ================== DEPOSIT ================== */
async function deposit(){
  if(!signer) return showMsg(text[lang].needConnect,"red");
  const v=$("amount").value.trim(); if(!v)return showMsg("‚ö†Ô∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô DNX");
  try{
    const amt=ethers.utils.parseUnits(v,dec);
    await ensureApprove(amt);
    const tx=await chef.deposit(amt);
    showMsg("‚õΩ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...");
    await tx.wait();
    showMsg("‚úÖ ‡∏ù‡∏≤‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    play("rewardSound");
    $("amount").value="";
    refreshData();
  }catch(e){console.error(e);showMsg("‚ùå ‡∏ù‡∏≤‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß","red");}
}
$("deposit").onclick=deposit;

/* ================== WITHDRAW ================== */
async function withdraw(){
  if(!signer) return showMsg(text[lang].needConnect,"red");
  const v=$("amount").value.trim(); if(!v)return showMsg("‚ö†Ô∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô DNX");
  try{
    const amt=ethers.utils.parseUnits(v,dec);
    const tx=await chef.withdraw(amt);
    showMsg("‚õΩ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...");
    await tx.wait();
    showMsg("‚úÖ ‡∏ñ‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    play("rewardSound");
    $("amount").value="";
    refreshData();
  }catch(e){console.error(e);showMsg("‚ùå ‡∏ñ‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß","red");}
}
$("withdraw").onclick=withdraw;

/* ================== CLAIM REWARD ================== */
async function claim(){
  if(!signer) return showMsg(text[lang].needConnect,"red");
  try{
    const tx=await chef.deposit(0);
    showMsg("üéÅ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...");
    await tx.wait();
    showMsg("‚úÖ ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    $("claim").classList.add("glowClaim");
    play("rewardSound");
    setTimeout(()=>$("claim").classList.remove("glowClaim"),900);
    refreshData();
  }catch(e){console.error(e);showMsg("‚ùå ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß","red");}
}
$("claim").onclick=claim;

/* ================== BUY DNX ================== */
function buyDNX(){
  play("clickSound");
  window.open("https://pancakeswap.finance/swap?outputCurrency="+TOKEN,"_blank");
}
$("buyDNX").onclick=buyDNX;

/* ================== GET PRICE FROM PANCAKE ================== */
async function updatePrice(){
  try{
    const res=await fetch(PANCAKE_API);
    const data=await res.json();
    priceUSD=parseFloat(data.data.price);
    console.log("üí∞ DNX/USD =",priceUSD);
    refreshData();
  }catch(e){console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å PancakeSwap ‡πÑ‡∏î‡πâ");}
}
updatePrice();
setInterval(updatePrice,60000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

</script>
